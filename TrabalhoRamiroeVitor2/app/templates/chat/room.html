{% extends "base.html" %}
{% block title %}Sala: {{ room.name }}{% endblock %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="m-0">Sala: {{ room.name }} {% if room.is_private %}<span class="badge text-bg-secondary">Privada</span>{% endif %}</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('chat.index') }}">Voltar às salas</a>
    <button class="btn btn-outline-primary" id="copy-link">Copiar link</button>
  </div>
</div>

<div id="chat-box" class="border rounded p-3 mb-3 bg-white" style="height: 380px; overflow-y: auto;">
  {% for m in messages %}
    <div><strong>{{ m.user.name }}:</strong> {{ m.content|safe }} <span class="text-muted small">{{ m.created_at.strftime('%H:%M') }}</span></div>
  {% endfor %}
</div>

<form id="chat-form" class="d-flex gap-2" method="POST" action="#">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input id="chat-input" class="form-control" placeholder="Digite uma mensagem..." autocomplete="off">
  <button class="btn btn-primary" type="submit">Enviar</button>
</form>

{% if current_user.is_moderator %}
<hr>
<h5>Moderação</h5>
<form method="POST" action="{{ url_for('chat.ban', room_id=room.id) }}" class="row g-2">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="col-md-3">
    <input name="user_id" class="form-control" placeholder="ID do usuário" required>
  </div>
  <div class="col-md-3">
    <input name="minutes" type="number" min="0" class="form-control" placeholder="Minutos (0 = permanente)" value="60">
  </div>
  <div class="col-md-4">
    <input name="reason" class="form-control" placeholder="Motivo (opcional)">
  </div>
  <div class="col-md-2">
    <button class="btn btn-warning w-100">Banir</button>
  </div>
</form>
{% endif %}

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const ROOM_ID = {{ room.id }};
  const TOKEN = {{ ("'" ~ token ~ "'") if token else "null" }};

  document.getElementById('copy-link').addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert('Link da sala copiado!');
    } catch (e) {
      alert('Não foi possível copiar. Copie manualmente: ' + window.location.href);
    }
  });
</script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}
